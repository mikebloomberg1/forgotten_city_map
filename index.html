<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Forgotten City – Tract-Level Feasibility Explorer</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <!-- Mapbox GL JS -->
    <link
      href="https://api.mapbox.com/mapbox-gl-js/v3.2.0/mapbox-gl.css"
      rel="stylesheet"
    />
    <script src="https://api.mapbox.com/mapbox-gl-js/v3.2.0/mapbox-gl.js"></script>
    <style>
      :root {
        --bg: rgba(255, 255, 255, 0.95);
        --shadow: 0 0 6px rgba(0, 0, 0, 0.25);
        --border-radius: 6px;
        --font: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
          sans-serif;
      }

      body {
        margin: 0;
        padding: 0;
        font-family: var(--font);
      }

      #map {
        position: absolute;
        top: 0;
        bottom: 0;
        width: 100%;
      }

      .panel {
        position: absolute;
        top: 10px;
        left: 10px;
        right: 10px;
        max-width: 780px;
        background: var(--bg);
        padding: 10px 12px;
        border-radius: var(--border-radius);
        box-shadow: var(--shadow);
        font-size: 12px;
      }

      .panel-row {
        display: flex;
        flex-wrap: wrap;
        gap: 10px 16px;
        align-items: center;
        margin-bottom: 6px;
      }

      .panel-row:last-child {
        margin-bottom: 0;
      }

      .panel-label {
        font-weight: 600;
        margin-right: 6px;
        white-space: nowrap;
      }

      .panel-group {
        display: flex;
        flex-wrap: wrap;
        gap: 4px 8px;
        align-items: center;
      }

      .panel input[type="radio"] {
        margin-right: 3px;
      }

      .slider-wrapper {
        display: flex;
        align-items: center;
        gap: 8px;
        min-width: 220px;
      }

      #costFactorSlider {
        width: 140px;
      }

      .legend {
        position: absolute;
        bottom: 20px;
        left: 20px;
        background: white;
        padding: 10px 12px;
        border-radius: var(--border-radius);
        font-size: 12px;
        box-shadow: var(--shadow);
      }

      .legend-title {
        font-weight: 600;
        margin-bottom: 4px;
      }

      .legend-row {
        display: flex;
        align-items: center;
        margin-bottom: 3px;
      }

      .legend-color {
        width: 14px;
        height: 14px;
        margin-right: 6px;
        border-radius: 2px;
      }

      .info-text {
        margin-bottom: 4px;
      }

      /* Data sources box */
      #data-info {
        position: absolute;
        bottom: 20px;
        right: 20px;
        background: white;
        padding: 10px 12px;
        border-radius: var(--border-radius);
        font-size: 11px;
        box-shadow: var(--shadow);
        max-width: 260px;
        line-height: 1.4;
      }

      @media (max-width: 700px) {
        .panel {
          max-width: none;
        }

        #data-info {
          max-width: 200px;
        }
      }
    </style>
  </head>
  <body>
    <div id="map"></div>

    <div class="panel">
      <div class="info-text">
        <strong>Forgotten City – Residual Land Value Explorer</strong><br />
        Adjust assumptions below. Map shows income-based residual land value per
        unit: red = negative (subsidy needed), blue = positive (feasible).
      </div>

      <div class="panel-row">
        <span class="panel-label">Building type</span>
        <div class="panel-group">
          <label>
            <input type="radio" name="buildingType" value="mf" checked />
            Small multifamily
          </label>
          <label>
            <input type="radio" name="buildingType" value="sf" />
            Single-family
          </label>
        </div>
      </div>

      <div class="panel-row">
        <span class="panel-label">Income share</span>
        <div class="panel-group">
          <label>
            <input type="radio" name="incomeShare" value="0.30" checked />
            30%
          </label>
          <label>
            <input type="radio" name="incomeShare" value="0.35" />
            35%
          </label>
          <label>
            <input type="radio" name="incomeShare" value="0.40" />
            40%
          </label>
        </div>
      </div>

      <div class="panel-row">
        <span class="panel-label">Construction cost</span>
        <div class="slider-wrapper">
          <input
            type="range"
            id="costFactorSlider"
            min="70"
            max="150"
            value="100"
          />
          <span id="costFactorLabel">100% of baseline</span>
        </div>
      </div>
    </div>

    <div class="legend">
      <div class="legend-title">Residual land value (L) per unit</div>
      <div class="legend-row">
        <div class="legend-color" style="background:#b2182b;"></div>
        <span>More negative (less feasible)</span>
      </div>
      <div class="legend-row">
        <div
          class="legend-color"
          style="background:#f7f7f7; border: 1px solid #ccc;"
        ></div>
        <span>Around 0</span>
      </div>
      <div class="legend-row">
        <div class="legend-color" style="background:#2166ac;"></div>
        <span>More positive (more feasible)</span>
      </div>
    </div>

    <!-- Data sources / assumptions box -->
    <div id="data-info">
      <strong>Data & assumptions</strong><br />
      Income: ACS 5-year 2018–2022 (median household income by tract).<br />
      Construction baselines (ex land, incl. profit):<br />
      &nbsp;&nbsp;• SF: $162/ft² (NAHB Cost of Constructing a Home, 2024).<br />
      &nbsp;&nbsp;• Small MF: $200/ft² (industry low-rise baseline).<br />
      State costs = baseline × modeled cost multiplier. C (ex land) = unit size
      × state cost/ft². L = P − C.
    </div>

    <script>
      // === MAPBOX SETUP ===
      mapboxgl.accessToken =
        "pk.eyJ1IjoibWVibG9vbWJlcmciLCJhIjoiY20ycWw5b3JmMTNtdTJsb21lYWZpemIyMCJ9.P-EVTtAL-ZTeKTNGCFW6Fw";

      const TILESET_URL = "mapbox://mebloomberg.b8cuu3jw";
      const SOURCE_LAYER_NAME = "tracts_residual_multi_base-auqwu3";

      const map = new mapboxgl.Map({
        container: "map",
        style: "mapbox://styles/mapbox/light-v11",
        center: [-98.5, 39.8],
        zoom: 3.3,
      });

      map.addControl(new mapboxgl.NavigationControl(), "top-right");

      // === STATE FOR CONTROLS ===
      let currentBuildingType = "mf"; // "mf" or "sf"
      let currentIncomeShare = 0.3; // 0.30, 0.35, 0.40
      let currentCostFactor = 1.0; // 0.7–1.5

      function getShareFactor() {
        // P_base is at 30% of income; scale linearly with share
        return currentIncomeShare / 0.3;
      }

      function getCostFactor() {
        return currentCostFactor;
      }

      function makeFillColorExpression() {
        const shareFactor = getShareFactor();
        const costFactor = getCostFactor();

        const costField =
          currentBuildingType === "mf"
            ? "C_ex_land_small_multifamily_base"
            : "C_ex_land_single_family_base";

        const L_expr = [
          "-",
          ["*", ["get", "P_income_base"], shareFactor],
          ["*", ["get", costField], costFactor],
        ];

        return [
          "case",
          [
            "all",
            ["==", ["typeof", ["get", "P_income_base"]], "number"],
            ["==", ["typeof", ["get", costField]], "number"],
          ],
          [
            "interpolate",
            ["linear"],
            L_expr,
            -100000,
            "#b2182b",
            0,
            "#f7f7f7",
            600000,
            "#2166ac",
          ],
          "#cccccc",
        ];
      }

      function updateMapStyle() {
        if (!map.getLayer("tract-fills")) return;
        const expr = makeFillColorExpression();
        map.setPaintProperty("tract-fills", "fill-color", expr);
      }

      map.on("load", () => {
        map.addSource("tracts", {
          type: "vector",
          url: TILESET_URL,
        });

        map.addLayer({
          id: "tract-fills",
          type: "fill",
          source: "tracts",
          "source-layer": SOURCE_LAYER_NAME,
          paint: {
            "fill-color": makeFillColorExpression(),
            "fill-opacity": 0.7,
          },
        });

        map.addLayer({
          id: "tract-borders",
          type: "line",
          source: "tracts",
          "source-layer": SOURCE_LAYER_NAME,
          paint: {
            "line-color": "#000000",
            "line-width": [
              "interpolate",
              ["linear"],
              ["zoom"],
              3,
              0.1,
              8,
              0.4,
            ],
            "line-opacity": 0.3,
          },
        });

        const popup = new mapboxgl.Popup({
          closeButton: false,
          closeOnClick: true,
        });

        map.on("click", "tract-fills", (e) => {
          const props = e.features[0].properties;
          const geoid = props.GEOID || "Unknown GEOID";

          const P_base = Number(props.P_income_base);
          const C_mf = Number(props.C_ex_land_small_multifamily_base);
          const C_sf = Number(props.C_ex_land_single_family_base);

          const shareFactor = getShareFactor();
          const costFactor = getCostFactor();

          const C_base = currentBuildingType === "mf" ? C_mf : C_sf;

          const P = P_base * shareFactor;
          const C = C_base * costFactor;
          const L = P - C;

          const fmtCurrency = (val) =>
            isFinite(val)
              ? val.toLocaleString("en-US", {
                  style: "currency",
                  currency: "USD",
                  maximumFractionDigits: 0,
                })
              : "N/A";

          const fmtNumber = (val) =>
            isFinite(val)
              ? val.toLocaleString("en-US", {
                  maximumFractionDigits: 0,
                })
              : "N/A";

          const buildingLabel =
            currentBuildingType === "mf" ? "Small multifamily" : "Single-family";

          // Try to pull median income, state abbr, multiplier, and cost-per-sqft if present
          const medianIncome = Number(
            props.median_household_income ?? props.median_income
          );
          const stateAbbr = props.state_abbr || "";
          const multiplier = props.multiplier
            ? Number(props.multiplier)
            : NaN;
          const costPerSqft = props.cost_per_sqft_state
            ? Number(props.cost_per_sqft_state)
            : NaN;

          const L_color = L >= 0 ? "blue" : "red";

          const html = `
            <div style="font-size:13px; line-height:1.4;">
              <strong>GEOID:</strong> ${geoid}<br/>
              <strong>Building type:</strong> ${buildingLabel}<br/>
              <strong>Income share:</strong> ${Math.round(
                currentIncomeShare * 100
              )}%<br/>
              <strong>Construction cost factor:</strong> ${Math.round(
                currentCostFactor * 100
              )}% of baseline
              <hr style="margin:4px 0;"/>
              <strong>P (income-based value):</strong> ${fmtCurrency(P)}<br/>
              <strong>C (ex land):</strong> ${fmtCurrency(C)}<br/>
              <strong>L = P − C:</strong>
              <span style="color:${L_color}; font-weight:600;">
                ${fmtCurrency(L)}
              </span>
              <hr style="margin:4px 0;"/>
              <strong>Data for this tract</strong><br/>
              <strong>Median household income:</strong>
              ${fmtCurrency(medianIncome)}<br/>
              <em>Source: ACS 5-year 2018–2022</em><br/><br/>
              <strong>State:</strong> ${stateAbbr || "N/A"}<br/>
              <strong>State cost multiplier:</strong>
              ${isFinite(multiplier) ? multiplier.toFixed(2) : "N/A"}<br/>
              <strong>Effective cost per ft²:</strong>
              ${isFinite(costPerSqft) ? "$" + fmtNumber(costPerSqft) + "/ft²" : "N/A"}<br/><br/>
              <small style="opacity:0.7;">
                Baselines (ex land, incl. profit): SF = $162/ft² (NAHB 2024),
                Small MF = $200/ft² (industry). State costs are baseline ×
                multiplier. C (ex land) = unit size × state cost/ft². L = P − C.
              </small>
            </div>
          `;

          popup.setLngLat(e.lngLat).setHTML(html).addTo(map);
        });

        map.on("mouseenter", "tract-fills", () => {
          map.getCanvas().style.cursor = "pointer";
        });

        map.on("mouseleave", "tract-fills", () => {
          map.getCanvas().style.cursor = "";
        });
      });

      // === CONTROL WIRING ===
      const costSlider = document.getElementById("costFactorSlider");
      const costLabel = document.getElementById("costFactorLabel");

      costSlider.addEventListener("input", () => {
        const val = Number(costSlider.value); // 70–150
        currentCostFactor = val / 100.0;
        costLabel.textContent = `${val}% of baseline`;
        updateMapStyle();
      });

      document
        .querySelectorAll('input[name="buildingType"]')
        .forEach((el) => {
          el.addEventListener("change", () => {
            currentBuildingType = el.value; // "mf" or "sf"
            updateMapStyle();
          });
        });

      document
        .querySelectorAll('input[name="incomeShare"]')
        .forEach((el) => {
          el.addEventListener("change", () => {
            currentIncomeShare = Number(el.value);
            updateMapStyle();
          });
        });
    </script>
  </body>
</html>

